//Graficos
#include "windows.h"
#include "OpenGL.h"
#include "glut.h"
//Standar C++
#include <time.h>
#include <math.h>
#include <iostream>
//Funciones de Juego
#include "FuncionesIni.h"
#include "Elemento.h"
#include "World.h"
#include "Camera.h"
#include "Interfaz.h"
#include "funciones_inline.h"
#include "Vector.h"
#include "Barco.h"
#include "Roca.h"
#include "PlayerList.h"
#include "GameCounter.h"

////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////																	////
////							Inicializacion							////
////																	////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////
//                          Funciones glut								//
//////////////////////////////////////////////////////////////////////////

void OnDraw(void);
void OnTimer(int value);
void OnKeyboardDown(BYTE key, int x, int y);
void OnMouseMotion(int x, int y);
void OnMouseMotionClick(int, int, int x, int y);

//////////////////////////////////////////////////////////////////////////
//                    Flags y variables globales						//
//////////////////////////////////////////////////////////////////////////

Posicion pti;									//Variable de click inicio
Posicion ptf;									//Variable de click final
Vector posRatonW;								//Guarda la posicion del raton en la ventana
Vector posRaton;								//Guarda la posicion del raton en todo momento
Posicion *periferias[((WORLDSIZE - 1) / 2)];	//Vector de periferias de analisis
Camera *camera = new Camera(20,20,20);			//Camara en uso por el jugador

//////////////////////////////////////////////////////////////////////////
//                    Inicializacion de jugadores						//
//////////////////////////////////////////////////////////////////////////

PlayerList pList;

//////////////////////////////////////////////////////////////////////////
//								 Mundo									//
//////////////////////////////////////////////////////////////////////////

World superficie(0);

//////////////////////////////////////////////////////////////////////////
//                         Intrefaz Jugador								//
//////////////////////////////////////////////////////////////////////////

Interfaz interfaz;

//////////////////////////////////////////////////////////////////////////
//                         Gestion del turno							//
//////////////////////////////////////////////////////////////////////////

GameCounter turno;

////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////																	////
////							Main									////
////																	////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////

void func(int value)
{
	std::cout << value;
}

int main(int argc,char* argv[])
{
	//Abre la ventana y GL
	inicializaVentana(argc, argv);

	//llama a los calbacks del juego
	glutDisplayFunc(OnDraw);
	glutTimerFunc(10, OnTimer, 0); //10 ms
	glutKeyboardFunc(OnKeyboardDown);
	glutMouseFunc(OnMouseMotionClick);
	glutMotionFunc(OnMouseMotion);
	glutPassiveMotionFunc(OnMouseMotion);
	srand(time(NULL));
	glClearColor(0.7, 1.0, 1.0, 0);
	
	//PlaySound(L"MaC.wav", NULL, SND_ASYNC | SND_FILENAME | SND_LOOP);

	//Creacion de periferias
	for (int i = 0; i < ((WORLDSIZE - 1) / 2); i++)
		periferias[i] = periferiaFinder(i + 1);

	//Poner contenido a mundo
	pList[0].myShips.addShip(new Barco(2, 2));
	pList.addWorldContent(&superficie);

	//inicializar los turnos
	turno.iniGameCounter(&pList);

	//Entrada en el bucle de funcion
	glutMainLoop();

	return 0; 
} 

////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////
////																	////
////						funciones CALLBACK							////
////																	////
////////////////////////////////////////////////////////////////////////////
////////////////////////////////////////////////////////////////////////////

//////////////////////////////////////////////////////////////////////////
//								 Dibujo									//
//////////////////////////////////////////////////////////////////////////

void OnDraw(void) {
	float vista[9];
	camera->getBackCamera(vista);
	switch (interfaz.sMenu){
		//Menu
		case 0:
			interfaz.Menu(camera);
			//if (interfaz.sMenu == 0)OpenGL::Print("Enter", 400, 500, 256, 256, 256);
			break;
		//Tanto para el caso del jugador 1 como el 2, se pinta el mismo mundo, solo se pone la camara al otro lado del tablero
		//Etapa Libre
		default:

			///////////////////////////////////TEMP////////////////////////////////////
			camera = &pList[0].pCamera;
			///////////////////////////////////////////////////////////////////////////

			glClear(GL_COLOR_BUFFER_BIT | GL_DEPTH_BUFFER_BIT); //Para definir el punto de vista
			glMatrixMode(GL_MODELVIEW);
			glLoadIdentity();

			gluLookAt(
				vista[0], vista[1], vista[2], // posicion del ojo
				vista[3], vista[4], vista[5], // hacia que punto mira (0,0,0) 
				vista[6], vista[7], vista[8]  // definimos hacia arriba (eje Y)
				);


			Casilla::lightUp(posRaton[x], posRaton[y]);			//Es la funcion que ilumina la casilla donde esta el raton

			glColor3ub(2, 2, 2);
			glTranslatef(posRaton[x], posRaton[y], posRaton[z]);
			glutSolidSphere(0.05, 20, 20);
			glTranslatef(-posRaton[x], -posRaton[y], -posRaton[z]);

			superficie.doDrawWorldMap();
			superficie.doDrawWorldContent();
			superficie.drawOption(posRatonW[x], posRatonW[y], pti);
			superficie.doDrawRange(pti);

			superficie.drawOption(posRatonW[x], posRatonW[y],pti);
			break;
	}
	glutSwapBuffers();//Cambia los buffer de dibujo, no borrar esta linea ni poner nada despues
}

//////////////////////////////////////////////////////////////////////////
//                         Temporizada									//
//////////////////////////////////////////////////////////////////////////
void OnTimer(int value)					//poner aqui el codigo de animacion
{

	glutTimerFunc(10,OnTimer,0);		//Temporizador de actulizacion
	glutPostRedisplay();				//Actualizacion de pantalla

}

//////////////////////////////////////////////////////////////////////////
//                         Movimiento de raton							//
//////////////////////////////////////////////////////////////////////////

void OnMouseMotion(int x, int y)
{
	interfaz.MovimientoRaton(x, y);
}

//////////////////////////////////////////////////////////////////////////
//							  Click de raton							//
//////////////////////////////////////////////////////////////////////////

void OnMouseMotionClick(int p, int pp, int _x, int _y)
{
	interfaz.InterfazRaton(p, pp, _x, _y);
}

//////////////////////////////////////////////////////////////////////////
//                         Pulsacion de teclado							//
//////////////////////////////////////////////////////////////////////////

void OnKeyboardDown(BYTE key, int x_t, int y_t)
{
	interfaz.InterfazTeclado(key, camera);
	std::cout << "Key";
}

//////////////////////////////////////////////////////////////////////////
//									FIN									//
//////////////////////////////////////////////////////////////////////////